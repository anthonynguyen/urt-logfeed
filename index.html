<!doctype html>
<html>
	<head>
		<title>UrT Log Streamer</title>
		<link href='http://fonts.googleapis.com/css?family=Open+Sans:400' rel='stylesheet' type='text/css'>
		<style type="text/css">
			* {
				margin: 0;
				outline: 0;
				padding: 0;
			}
			
			body {
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
				background-color: #eee;
				font-family: 'Open Sans', sans-serif;
				font-size: 11pt;
				width: 100%;
			}
			
			section#filter {
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
				display: block;
				float: left;
				position: fixed;
				width: 200px;
			}
			
			section#logcontainer {
				display: block;
				font-size: 0.8em;
				margin-left: 200px;
			}
			
			#log {
				list-style-type: none;
			}
			
			#log li {
				background: #fff;
				border: 1px solid #d2d2d2;
				padding: 10px;
				margin: 6px 15px;
			}
				
			.ev-label {
				color: #fff;
				font-size: 0.9em;
				margin-right: 10px;
				padding: 2px 4px;
				position: absolute;
				text-transform: uppercase;
			}
			
			.ev-data {
				margin-left: 130px;
			}
			
			.client {
				font-weight: bold;
			}

			.client:hover {
				text-decoration: underline;
			}
		
			.ev-kill {
				background: #E73F3F;
			}
			
			.ev-flag {
				background: #F76C27;
			}
			
			.ev-client {
				background: #6D9DD1;
			}
			
			.ev-game {
				background: #7E45D3;
			}
			
			.ev-chat {
				background: #5EB89B;
			}	
		</style>
	</head>
	<body>
		<section id="filter">
			<button id="pause-stream" onclick="togglePause()">Pause stream</button>
		</section>
		<section id="logcontainer">
			<ul id="log">
			</ul>
		</section>
		<script src="/socket.io/socket.io.js"></script>
		<script>
		var isPaused = false;
		var togglePause = function() {
			isPaused = !isPaused;
			var pauseButton = document.getElementById("pause-stream");
			if (isPaused) {
				pauseButton.innerHTML = "Resume stream";
			} else {
				pauseButton.innerHTML = "Pause stream";
			}
		}
		var getName = function(person) {
			if (person.name != null) {
				return '<span class="client">[' + person.id.toString() + ']' + person.name + '</span>';
			} else {
				return '<span class="client">Client [' + person.id.toString() + ']</span>';
			}
		}

		var MapChangeFormatter = function(event) {
			var parts = {};
			parts.type = "Map Load";
			parts.label = "ev-game";
			parts.data = "Map changed to " + event.data.map;
			return parts;
		}
		var InitRoundFormatter = function(event) {
			var parts = {};
			parts.type = "Round Start";
			parts.label = "ev-game";
			parts.data = "Round started.";
			return parts;
		}
		var InitAuthFormatter = function(event) {
			var parts = {};
			parts.type = event.type;
			parts.label = "ev-game";
			parts.data = "Auth intialized.";
			return parts;
		}
		var ShutdownGameFormatter = function(event) {
			var parts = {};
			parts.type = event.type;
			parts.label = "ev-game";
			parts.data = "Game stopped.";
			return parts;
		}
		var ClientDisconnectFormatter = function(event) {
			var parts = {};
			parts.type = "Disconnect";
			parts.label = "ev-client";
			parts.data = getName(event.subject) + " disconnected.";
			return parts;
		}
		var ClientRenameFormatter = function(event) {
			var parts = {};
			parts.type = "Rename";
			parts.label = "ev-client";
			parts.data = getName(event.subject) + " renamed to " + event.data.name;
			return parts;
		}
		var ClientTeamChangeFormatter = function(event) {
			var parts = {};
			parts.type = "Team";
			parts.label = "ev-client";
			parts.data = getName(event.subject) + " switched to the " + event.data.team + " team.";
			return parts;
		}
		var ClientSpawnFormatter = function(event) {
			var parts = {};
			parts.type = "Spawn";
			parts.label = "ev-client";
			parts.data = getName(event.subject) + " spawned.";
			return parts;
		}
		var ClientConnectFormatter = function(event) {
			var parts = {};
			parts.type = "Connect";
			parts.label = "ev-client";
			parts.data = getName(event.subject) + " connected.";
			return parts;
		}
		var sayFormatter = function(event) {
			var parts = {};
			parts.type = event.type;
			parts.label = "ev-chat";
			parts.data = getName(event.subject) + ": " + event.data.message;
			return parts;
		}
		var sayteamFormatter = function(event) {
			var parts = {};
			parts.type = event.type;
			parts.label = "ev-chat";
			parts.data = "(Team)" + getName(event.subject) + ": " + event.data.message;
			return parts;
		}
		var KillFormatter = function(event) {
			var parts = {};
			parts.type = event.type;
			if (event.data.type == 1) {
				parts.type = "teamkill";
			} else if (event.data.type == 2) {
				parts.type = "suicide";
			}
			parts.label = "ev-kill";
			parts.data = getName(event.subject) + " [" + event.data.weapon.name + "] " + getName(event.object);
			return parts;
		}
		var SurvivorWinnerFormatter = function(event) {
			var parts = {};
			parts.type = "Round End";
			parts.label = "ev-game";
			parts.data = event.data.team + " won a round.";
			return parts;
		}
		var FlagPickupFormatter = function(event) {
			var parts = {};
			parts.type = "Flag";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " grabbed the " + event.data.flag + " flag.";
			return parts;
		}
		var FlagDropFormatter = function(event) {
			var parts = {};
			parts.type = "Flag";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " dropped the " + event.data.flag + " flag.";
			return parts;
		}
		var FlagReturnFormatter = function(event) {
			var parts = {};
			parts.type = "Flag";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " returned the " + event.data.flag + " flag.";
			return parts;
		}
		var FlagCaptureFormatter = function(event) {
			var parts = {};
			parts.type = "Flag";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " captured the " + event.data.flag + " flag.";
			return parts;
		}
		var MapEndFormatter = function(event) {
			var parts = {};
			parts.type = event.type;
			parts.label = "ev-game";
			parts.data = "Map ended: " + event.data.reason;
			return parts;
		}
		var BombDropFormatter = function(event) {
			var parts = {};
			parts.type = "Bomb";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " dropped the bomb.";
			return parts;
		}
		var BombPickupFormatter = function(event) {
			var parts = {};
			parts.type = "Bomb";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " picked up the bomb.";
			return parts;
		}
		var BombPlantFormatter = function(event) {
			var parts = {};
			parts.type = "Bomb";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " planted the bomb.";
			return parts;
		}
		var BombDefuseFormatter = function(event) {
			var parts = {};
			parts.type = "Bomb";
			parts.label = "ev-flag";
			parts.data = getName(event.subject) + " defused the bomb.";
			return parts;
		}
		var BombExplodeFormatter = function(event) {
			var parts = {};
			parts.type = "Bomb";
			parts.label = "ev-flag";
			parts.data = "The bomb exploded.";
			return parts;
		}

		var socket = io();
		var eventFilter = {};
		var logList = document.getElementById("log");

		socket.on('event', function(event){
			if (isPaused || !eventFilter[event.type]) {
				return;
			}
			var parts = window[event.type + "Formatter"](event);
			var liText = '<li class="' + event.type + '"><span class="ev-label ' + parts.label + '">' + parts.type + '</span><span class="ev-data">' + parts.data + '</span></li>';
			logList.innerHTML += liText;
			window.scrollTo(0, document.body.scrollHeight);
		});
		socket.on("exposedEvents", function(list) {
			for (var i = 0; i < list.length; i++) {
				eventFilter[list[i]] = true;
			}
			var defaultHide = ["InitAuth", "ClientSpawn"];
			for (var i = 0; i < defaultHide.length; i++) {
				eventFilter[defaultHide[i]] = false;
			}

			var filter = document.getElementById("filter");
			for (var eType in eventFilter) {
				if (eventFilter[eType]) {
					var action = "Hide";
				} else {
					var action = "Show";
				}
				filter.innerHTML += '<button id="' + eType + '-toggle" onclick="toggleEvent(\'' + eType + '\')">' + action + ' ' + eType + '</button>';
			}
		});
		var toggleEvent = function(e) {
			eventFilter[e] = !eventFilter[e];
			console.log(e);
			var button = document.getElementById(e + "-toggle");
			if (eventFilter[e]) {
				button.innerHTML = "Hide " + e;
			} else {
				button.innerHTML = "Show " + e;
			}
		}
		</script>
	</body>
</html>
